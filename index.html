<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voyage — Co-founding the Future</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script type="module" crossorigin src="./index-BEfEoJVR.js"></script>
    <link rel="stylesheet" crossorigin href="./index-DGJEfosU.css">
  </head>

  <body>
    <div id="root"></div>

    <script>
      (function () {
        const FORMSPREE_ENDPOINT = "https://formspree.io/f/xbddgpby";

        // ✅ 只把这些“提交按钮文案”当作提交
        const SUBMIT_TEXT_RE = /^(submit application|submit|apply|send|提交|申请|发送)$/i;

        function isValidEmail(s) {
          const v = (s || "").trim();
          // 简单但够用的邮箱校验
          return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
        }

        function isVisible(el) {
          if (!el) return false;
          const style = window.getComputedStyle(el);
          if (style.display === "none" || style.visibility === "hidden") return false;
          const rects = el.getClientRects();
          return rects && rects.length > 0;
        }

        function clean(s) {
          return (s || "").toString().trim().replace(/\s+/g, " ");
        }

        function labelFor(el) {
          if (el.id) {
            const lab = document.querySelector(`label[for="${CSS.escape(el.id)}"]`);
            if (lab && clean(lab.innerText)) return clean(lab.innerText);
          }
          const near = el.closest && el.closest("label");
          if (near && clean(near.innerText)) return clean(near.innerText);
          const aria = el.getAttribute && el.getAttribute("aria-label");
          if (aria && clean(aria)) return clean(aria);
          const ph = el.getAttribute && el.getAttribute("placeholder");
          if (ph && clean(ph)) return clean(ph);
          const name = el.getAttribute && el.getAttribute("name");
          if (name && clean(name)) return clean(name);
          const id = el.id && clean(el.id);
          if (id) return id;
          return "";
        }

        // 收集当前卡片/弹窗内所有可见字段
        function collect(scopeEl) {
          const els = Array.from(scopeEl.querySelectorAll("input, textarea, select, [contenteditable='true']"))
            .filter(isVisible)
            .filter(el => !(el.tagName === "INPUT" && (el.type || "").toLowerCase() === "hidden"))
            .filter(el => !el.disabled);

          const data = {};
          els.forEach((el, idx) => {
            const key = labelFor(el) || `field_${idx + 1}`;
            const tag = (el.tagName || "").toLowerCase();
            const type = ((el.getAttribute && el.getAttribute("type")) || "").toLowerCase();

            if (type === "radio") {
              if (el.checked) data[key] = el.value || "on";
              return;
            }

            if (type === "checkbox") {
              data[key] = el.checked ? (el.value || "yes") : "no";
              return;
            }

            if (tag === "select") {
              const val = el.value ?? "";
              const text = (el.selectedOptions && el.selectedOptions[0] && el.selectedOptions[0].text) ? el.selectedOptions[0].text : "";
              data[key] = text ? `${val} (${text})` : val;
              return;
            }

            if (el.getAttribute && el.getAttribute("contenteditable") === "true") {
              data[key] = clean(el.innerText);
              return;
            }

            data[key] = el.value ?? "";
          });

          return data;
        }

        // ✅ 只认“真正的提交按钮”
        function findRealSubmitButton(clickedEl) {
          let el = clickedEl;
          for (let i = 0; i < 12 && el; i++) {
            const txt = clean(el.innerText || el.value || "");
            // 必须文本完全匹配（避免你点任何区域都触发）
            if (txt && SUBMIT_TEXT_RE.test(txt)) return el;
            // 也允许 aria-label 完全匹配
            const aria = clean(el.getAttribute ? el.getAttribute("aria-label") : "");
            if (aria && SUBMIT_TEXT_RE.test(aria)) return el;
            el = el.parentElement;
          }
          return null;
        }

        async function postJson(payload) {
          const res = await fetch(FORMSPREE_ENDPOINT, {
            method: "POST",
            headers: {
              "Accept": "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });
          return res;
        }

        document.addEventListener("click", async (e) => {
          const submitEl = findRealSubmitButton(e.target);
          if (!submitEl) return;

          e.preventDefault();
          e.stopPropagation();

          // 作用域：优先找对话框/卡片容器
          const scope =
            submitEl.closest("[role='dialog']") ||
            submitEl.closest("section") ||
            submitEl.closest("main") ||
            submitEl.closest("div") ||
            document;

          const fields = collect(scope);

          // 从 fields 里尽量找 email
          const emailCandidates = [
            fields.email, fields.Email, fields["E-mail"], fields["Email Address"], fields["email address"],
            fields["Your email"], fields["Your Email"]
          ].map(v => clean(v)).filter(Boolean);

          const email = emailCandidates[0] || "";
          // message：把关键长文本拼起来（避免 422）
          const message = [
            fields.message, fields.Message,
            fields["What are you building? (Optional)"],
            fields["What are you building?"],
            fields["Why Voyage? (Optional)"],
            fields["Why Voyage?"],
          ].map(v => clean(v)).filter(Boolean).join("\n\n");

          // ✅ 如果没有合法邮箱，就不提交（避免 422）
          if (!isValidEmail(email)) {
            alert("Please enter a valid email address before submitting.");
            return;
          }

          const payload = {
            email,
            message: message || "(no message)",
            // 附加所有字段（Formspree 会一起发到邮件里）
            ...fields,
            _page: location.href,
            _ts: new Date().toISOString(),
            _subject: "New Co-founder Application",
          };

          console.log("[Formspree] payload preview:", payload);

          try {
            submitEl.style.pointerEvents = "none";

            const res = await postJson(payload);
            if (res.ok) {
              alert("Submitted! We’ll get back to you soon.");
            } else {
              const body = await res.json().catch(() => null);
              console.error("[Formspree] error:", res.status, body);
              alert("Submit failed. Please open DevTools → Network/Console for details.");
            }
          } catch (err) {
            console.error(err);
            alert("Submit failed. Please try again.");
          } finally {
            submitEl.style.pointerEvents = "";
          }
        }, true);
      })();
    </script>
  </body>
</html>
